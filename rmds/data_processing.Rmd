---
title: "smartchem_raw_to_db"
author: "Keith Birchfield"
date: "February 8, 2019"
output: 
  html_document:
    toc: TRUE
    df_print: paged
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```

## Description

This Rmd is a record of the data processing for raw data files output from SmartChem 200 software. The goal is to prepare data for import into the pnw_lakes_data database. Preparation includes evaluation of quality control metrics and notes about any changes to the data set. 

### Samples in Data Set

This data set includes the following samples, all from Lacamas Lake:

  * 2014 Inlet and Outlet samples - only the DW profile samples from these runs were processed and imported into the database. The PO4 run was not successful and therefore is not included in the data processing here.
  
## Load required packages and functions

```{r}
library(tidyverse)
library(lubridate)
library(readxl)
library(cowplot)
library(plotly)
library(here)
source(here("functions", "smartchem_rawprocessor.R"))
source(here("functions", "sc_qc_multiplot_fun.R"))
source(here("functions", "sc_cal_curve_plot.R"))
source(here("functions", "sc_controls_plot.R"))
source(here("functions", "sc_absdups_plot.R"))
source(here("functions", "sc_no3coileffic_plot.R"))
```

## Import data

Make a list of file names in the raw_data folder

```{r}
filenames_raw <-
  list.files(here("raw_data"), pattern = "*\\.XLS", ignore.case = T, full.names = F)
filenames_raw
```

Specify the run dates for each file in filenames.orig and create a dataframe of filenames and their associated rundates
```{r}
run_dates_df <- as_tibble(list(filenames = filenames_raw, 
                               run_dates  = date(c("2015-04-09", "2015-04-07", "2015-04-08"))))
run_dates_df
```

## WNHR - Ammonia analysis data processing

### Import and Process excel workbook

```{r}
nh3_run <- smartchem_rawprocessor(filename = filenames_raw[2])
nh3_run
```

Check the method to make sure it is an ammonia method (WNHR or WNHA)

```{r}
nh3_run$method
```


### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(nh3_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(nh3_run)
```


```{r}
#nh3_controls_plot <- 
# nh3_run$controls %>% mutate(Concentration = ifelse(SampleID == "BLNK" & Concentration > 0.25, NA, Concentration)) %>% 
#   ggplot(aes(RunTime, Concentration, color = SampleID)) +
#   geom_point() +
#   geom_line() +
#   geom_smooth(method = "lm", se = F) +
#   ggtitle(label = paste(nh3_run$method, "- Controls", nh3_run$run_date)) + 
#   xlab("Runtime") +
#   ylab("Concentration") +
#   #theme(legend.position = "top") +
#   geom_hline(yintercept = unique(nh3_run$controls$Nominal), linetype = 2)
# ggplotly(nh3_controls_plot) %>% 
#   layout(legend = list(orientation = "h", y = 1.05))
```



```{r}
nh3_midcheck_pctrec <- 
  nh3_run$controls %>% 
  filter(SampleID == "CCA1") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(nh3_run$method, "- Midrange Check % Recovery ", nh3_run$run_date))
ggplotly(nh3_midcheck_pctrec)

```

The nominal value for the midrange check standard was incorrect for this run. It was entered as 0.25 but should have been 0.5. I'll update that and recalculate % recovery, then pipe the result into the plot.

```{r}
nh3_run$controls %>% 
  mutate(Nominal = case_when(Nominal == 0.25 ~ 0.50,
                             Nominal != 0.25 ~ Nominal),
         Recovery_PRD = case_when(Nominal == 0.5 ~ 100 * Concentration/Nominal)) %>% 
  filter(SampleID == "CCA1") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(nh3_run$method, "- Midrange Check % Recovery ", nh3_run$run_date))
ggplotly(nh3_midcheck_pctrec)
```


The checks and blanks were good on this run. 


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(nh3_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(nh3_run)
```

```{r}
hist(nh3_run$dups$abs_diff_conc)
```


```{r}
nh3_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```




### Data quality and corrections assessment


Assessment:


Mid-range check standards and blanks were good on the whole for ammonia. Dups looked good as well with an average absolute diff of less than 0.005 ppm, which is 1% of the mid-range check standard. 

Corrections and reruns:
* None required

Add metadata and save to merge with results of other analytes.

```{r}
nh3_results_final <- 
nh3_run$result %>% 
  mutate(method = nh3_run$method,
         analyte = "nh3")

nh3_results_final
```

## SMPL - Phosphate (no data)

### Import and Process excel workbook

```{r}
# po4_run <- smartchem_rawprocessor(filename = filenames_raw[2])
# po4_run
```

Check the method to make sure it is a phosphate method (SMPL)

```{r}
# po4_run$method
```

### Quality Control Checks

1. Calibration curve

```{r}
# sc_cal_curve_plot(po4_run)
```

2. Check Standards and Controls

```{r}
# sc_controls_plot(po4_run)
```


```{r}
# po4_midcheck_pctrec <- 
#   po4_run$controls %>% 
#   filter(SampleID == "CCV1") %>% 
#   ggplot(aes(RunTime, Recovery_PRD)) +
#   geom_point() + 
#   geom_line() +
#   geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
#   labs(title = paste(po4_run$method, "- Midrange Check % Recovery ", po4_run$run_date))
# ggplotly(po4_midcheck_pctrec)

```


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
# sc_absdups_plot(po4_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
# sc_qc_multiplot_fun(po4_run)
```

```{r}
# hist(po4_run$dups$abs_diff_conc)
```


```{r}
# po4_run$dups %>% 
  # summarise(avg_abs_diff = mean(abs_diff_conc),
  #           sd_abs_diff = sd(abs_diff_conc), 
  #           n_abs_diff = n(),
  #           cv = sd_abs_diff/avg_abs_diff)
```


### Data quality and corrections assessment

Overall, the controls were ok for this run. Mid-range checks ran a little high, but aside from one check at time 15:34, all mid-range check standards were within 0.01ppm of the 0.05ppm check standard. Duplicates averaged 0.002ppm in absolute difference for the run. No corrections or reruns are determined necessary at this time. 

Before adding metadata, fix a typo in SampleID for observation # 4. 
```{r}
# po4_run$result$SampleID[4]
# 
# po4_run$result$SampleID[4] <- "1586_Lac_DW_2018-01-09 15:00_9"
# 
# po4_run$result$SampleID[4]

```


Add metadata and save to merge with results of other analytes.

```{r}
# po4_results_final <- 
# po4_run$result %>% 
#   separate(SampleID, into = c("tbl_wsinfo_id", "reservoir", "site", "datetime", "depth_nominal"), sep = "_", remove = FALSE) %>% 
#   mutate(method = po4_run$method,
#          analyte = "po4",
#          date_col = date(datetime))
# 
# po4_results_final
```




## BNO2 - Nitrite

### Import and Process excel workbook

```{r}
no2_run <- smartchem_rawprocessor(filename = filenames_raw[3])
no2_run
```

Check the method to make sure it is a nitrite method (BNO2)

```{r}
no2_run$method
```


### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(no2_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(no2_run)
```


```{r}
no2_midcheck_pctrec <- 
  no2_run$controls %>% 
  filter(SampleID == "CCN2") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(no2_run$method, "- Midrange Check % Recovery ", no2_run$run_date))
ggplotly(no2_midcheck_pctrec)

```


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(no2_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(no2_run)
```
```{r}
hist(no2_run$dups$abs_diff_conc)
```


```{r}
no2_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```

### Data quality and corrections assessment

Overall, controls were good for this run. I assume the spikes in the blank mid-run were the result of the sample cup running empty. No corrections or reruns required.  

Add metadata and save to merge with results of other analytes.
```{r}
no2_results_final <- 
no2_run$result %>% 
  mutate(method = no2_run$method,
         analyte = "no2")

no2_results_final

```




## BNO3 - Nitrate

### Import and Process excel workbook

```{r}
no3_run <- smartchem_rawprocessor(filename = filenames_raw[1])
no3_run
```

Check the method to make sure it is a nitrate method (BNO3)

```{r}
no3_run$method
```


### Quality Control Checks

1. Calibration curve

```{r}
# sc_cal_curve_plot(no3_run)
```

The calibration curve data are missing. I'll look into this but assume that because this data set has been used elsewhere the calibration was good.

2. Check Standards and Controls

```{r}
sc_controls_plot(no3_run)
```
It appears that CCN2 and CCN3 were placed in the wrong positions for the first part of this run. 

```{r}
no3_midcheck_pctrec <- 
  no3_run$controls %>% 
  filter(SampleID == "CCN3") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(no3_run$method, "- Midrange Check % Recovery ", no3_run$run_date))
ggplotly(no3_midcheck_pctrec)

```
Once placed in the correct position, CCN3 was within normal range.

3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(no3_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(no3_run)
```

```{r}
hist(no3_run$dups$abs_diff_conc)
```


```{r}
no3_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```



Nitrate module coil efficiency

```{r}
sc_no3coileffic_plot(no3_run)
```

Mean coil efficiency (blue dotted line) = `r mean(no3_run$controls$coil_effic, na.rm = T)`
This is inaccurate because CCN3 and CCN2 were in the wrong positions. Once in the correct positions, coil efficiency was good.


### Data quality and corrections assessment

Overall, controls were good for this run. 

Add metadata and save to merge with results of other analytes.
```{r}
no3_results_final <- 
no3_run$result %>% 
  mutate(method = no3_run$method,
         analyte = "no3")

no3_results_final

```

## Merge all, filter down to include only inlet and outlet, add metadata, and export

```{r}
filename_dbimport <- paste0("sc_20190208_dbimport_", format(Sys.time(), format = "%Y%m%d%H%M"), ".csv")
filename_dbimport

bind_rows(list(nh3_results_final, 
               #po4_results_final, 
               no2_results_final, 
               no3_results_final)) %>% 
  filter(grepl("LAC-", SampleID)) %>% 
  separate(SampleID, into = c("reservoir", "datetime"), sep = "_", remove = F) %>% 
  separate(reservoir, into = c("reservoir", "site"), sep = "-", remove = T) %>% 
  mutate(site = case_when(site == "O" ~ "OUT",
                          site == "I" ~ "IN"),
         datetime = ymd_hm(paste0("20", datetime)),
         filename = filename_dbimport) %>%
  rename(sample_id = SampleID,
         sample_type = SampleType,
         run_time = RunTime) %>% 
  write_excel_csv(path = here("produced_data", filename_dbimport), 
                  na = "")
```



