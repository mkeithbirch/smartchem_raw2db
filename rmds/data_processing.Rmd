---
title: "smartchem_raw_to_db"
author: "Keith Birchfield"
date: "February 7, 2019"
output: 
  html_document:
    toc: TRUE
    df_print: paged
---

```{r setup, include=FALSE}
rm(list = ls())
knitr::opts_chunk$set(echo = TRUE)
```

## Description

This Rmd is a record of the data processing for raw data files output from SmartChem 200 software. The goal is to prepare data for import into the pnw_lakes_data database. Preparation includes evaluation of quality control metrics and notes about any changes to the data set. 

### Samples in Data Set

This data set includes the following samples, all from Lacamas Lake:

  * 2018 DW profile samples
  
## Load required packages and functions

```{r}
library(tidyverse)
library(lubridate)
library(readxl)
library(cowplot)
library(plotly)
library(here)
source(here("functions", "smartchem_rawprocessor.R"))
source(here("functions", "sc_qc_multiplot_fun.R"))
source(here("functions", "sc_cal_curve_plot.R"))
source(here("functions", "sc_controls_plot.R"))
source(here("functions", "sc_absdups_plot.R"))
source(here("functions", "sc_no3coileffic_plot.R"))
```

## Import data

Make a list of file names in the raw_data folder

```{r}
filenames_raw <-
  list.files(here("raw_data"), pattern = "*\\.XLS", ignore.case = T, full.names = F)
filenames_raw
```

Specify the run dates for each file in filenames.orig and create a dataframe of filenames and their associated rundates
```{r}
run_dates_df <- as_tibble(list(filenames = filenames_raw, 
                               run_dates  = date(c("2019-02-05", "2019-02-05", "2019-02-06", "2019-02-06"))))
run_dates_df
```

## WNHR - Ammonia analysis data processing

### Import and Process excel workbook

```{r}
nh3_run <- smartchem_rawprocessor(filename = filenames_raw[1])
nh3_run
```

Check the method to make sure it is an ammonia method (WNHR or WNHA)

```{r}
nh3_run$method
```


### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(nh3_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(nh3_run)
```


```{r}
#nh3_controls_plot <- 
# nh3_run$controls %>% mutate(Concentration = ifelse(SampleID == "BLNK" & Concentration > 0.25, NA, Concentration)) %>% 
#   ggplot(aes(RunTime, Concentration, color = SampleID)) +
#   geom_point() +
#   geom_line() +
#   geom_smooth(method = "lm", se = F) +
#   ggtitle(label = paste(nh3_run$method, "- Controls", nh3_run$run_date)) + 
#   xlab("Runtime") +
#   ylab("Concentration") +
#   #theme(legend.position = "top") +
#   geom_hline(yintercept = unique(nh3_run$controls$Nominal), linetype = 2)
# ggplotly(nh3_controls_plot) %>% 
#   layout(legend = list(orientation = "h", y = 1.05))
```



```{r}
nh3_midcheck_pctrec <- 
  nh3_run$controls %>% 
  filter(SampleID == "CCA1") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(nh3_run$method, "- Midrange Check % Recovery ", nh3_run$run_date))
ggplotly(nh3_midcheck_pctrec)

```

The checks and blanks were, for the most part, good on this run. Two of the mid-range checks were outside of the +/- 10% recovery range: one at timepoint 12:01:20 at 115% and one at timepoint 12:26:33 at 89%.



3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(nh3_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(nh3_run)
```

```{r}
hist(nh3_run$dups$abs_diff_conc)
```


```{r}
nh3_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```



### Data quality and corrections assessment


Assessment:


Mid-range check standards and blanks were good on the whole for ammonia. Dups looked good as well with an average absolute diff of less than 0.008 ppm, which is 1.6% of the mid-range check standard. 

Corrections and reruns:
* None required

Add metadata and save to merge with results of other analytes.

```{r}
nh3_results_final <- 
nh3_run$result %>% 
  separate(SampleID, into = c("ws_info_id", "reservoir", "site", "datetime", "depth_nominal"), sep = "_", remove = FALSE) %>% 
  mutate(method = nh3_run$method,
         analyte = "nh3",
         date_col = date(datetime))

nh3_results_final
```

## SMPL - Phosphate

### Import and Process excel workbook

```{r}
po4_run <- smartchem_rawprocessor(filename = filenames_raw[2])
po4_run
```

Check the method to make sure it is a phosphate method (SMPL)

```{r}
po4_run$method
```

### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(po4_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(po4_run)
```


```{r}
po4_midcheck_pctrec <- 
  po4_run$controls %>% 
  filter(SampleID == "CCV1") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(po4_run$method, "- Midrange Check % Recovery ", po4_run$run_date))
ggplotly(po4_midcheck_pctrec)

```


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(po4_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(po4_run)
```

```{r}
hist(po4_run$dups$abs_diff_conc)
```


```{r}
po4_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```


### Data quality and corrections assessment

Overall, the controls were ok for this run. Mid-range checks ran a little high, but aside from one check at time 15:34, all mid-range check standards were within 0.01ppm of the 0.05ppm check standard. Duplicates averaged 0.002ppm in absolute difference for the run. No corrections or reruns are determined necessary at this time. 

Before adding metadata, fix a typo in SampleID for observation # 4. 
```{r}
po4_run$result$SampleID[4]

po4_run$result$SampleID[4] <- "1586_Lac_DW_2018-01-09 15:00_9"

po4_run$result$SampleID[4]

```


Add metadata and save to merge with results of other analytes.

```{r}
po4_results_final <- 
po4_run$result %>% 
  separate(SampleID, into = c("ws_info_id", "reservoir", "site", "datetime", "depth_nominal"), sep = "_", remove = FALSE) %>% 
  mutate(method = po4_run$method,
         analyte = "po4",
         date_col = date(datetime))

po4_results_final
```




## BNO2 - Nitrite

### Import and Process excel workbook

```{r}
no2_run <- smartchem_rawprocessor(filename = filenames_raw[3])
no2_run
```

### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(no2_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(no2_run)
```


```{r}
no2_midcheck_pctrec <- 
  no2_run$controls %>% 
  filter(SampleID == "CCN2") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(no2_run$method, "- Midrange Check % Recovery ", no2_run$run_date))
ggplotly(no2_midcheck_pctrec)

```


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(no2_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(no2_run)
```
```{r}
hist(no2_run$dups$abs_diff_conc)
```


```{r}
no2_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```

### Data quality and corrections assessment

Overall, controls were excellent for this run. No corrections or reruns required.  

Add metadata and save to merge with results of other analytes.
```{r}
no2_results_final <- 
no2_run$result %>% 
  separate(SampleID, into = c("ws_info_id", "reservoir", "site", "datetime", "depth_nominal"), sep = "_", remove = FALSE) %>% 
  mutate(method = no2_run$method,
         analyte = "no2",
         date_col = date(datetime))

no2_results_final

```




## BNO3 - Nitrate

### Import and Process excel workbook

```{r}
no3_run <- smartchem_rawprocessor(filename = filenames_raw[4])
no3_run
```

### Quality Control Checks

1. Calibration curve

```{r}
sc_cal_curve_plot(no3_run)
```

2. Check Standards and Controls

```{r}
sc_controls_plot(no3_run)
```


```{r}
no3_midcheck_pctrec <- 
  no3_run$controls %>% 
  filter(SampleID == "CCN3") %>% 
  ggplot(aes(RunTime, Recovery_PRD)) +
  geom_point() + 
  geom_line() +
  geom_hline(yintercept = c(100, 90, 110), linetype = c(1,2,2), color = "green") +
  labs(title = paste(no3_run$method, "- Midrange Check % Recovery ", no3_run$run_date))
ggplotly(no3_midcheck_pctrec)

```


3. Duplicates analysis

  a. Absolute difference over time
  
```{r}
sc_absdups_plot(no3_run)
```


All three together for comparison

```{r, fig.height=10, fig.width=10}
sc_qc_multiplot_fun(no3_run)
```

```{r}
hist(no3_run$dups$abs_diff_conc)
```


```{r}
no3_run$dups %>% 
  summarise(avg_abs_diff = mean(abs_diff_conc),
            sd_abs_diff = sd(abs_diff_conc), 
            n_abs_diff = n(),
            cv = sd_abs_diff/avg_abs_diff)
```



Nitrate module coil efficiency

```{r}
sc_no3coileffic_plot(no3_run)
```

Mean coil efficiency (blue dotted line) = `r mean(no3_run$controls$coil_effic, na.rm = T)`


### Data quality and corrections assessment

Overall, controls were good for this run. 

Add metadata and save to merge with results of other analytes.
```{r}
no3_results_final <- 
no3_run$result %>% 
  separate(SampleID, into = c("ws_info_id", "reservoir", "site", "datetime", "depth_nominal"), sep = "_", remove = FALSE) %>% 
  mutate(method = no3_run$method,
         analyte = "no3",
         date_col = no3_run$run_date)

no3_results_final

```

## Merge all and export

```{r}
filename_dbimport <- paste0("sc_20190207_dbimport_", format(Sys.time(), format = "%Y%m%d%H%M"), ".csv")
filename_dbimport

bind_rows(list(nh3_results_final, 
               po4_results_final, 
               no2_results_final, 
               no3_results_final)) %>% 
  mutate(filename = filename_dbimport) %>% 
  write_excel_csv(path = here("produced_data", filename_dbimport), 
                  na = "")
```



